'use strict';

//var context = require('./context');
var utility = require('./utility');
var context = require('./context');
var simulate = require('./simulate');
var renderer = require('./renderer');
exports = module.exports;

var requests = new Array();
var simulations = new Array();


exports.createSimulation = function(req, res) {
    var size = 40;
    var newSimulation = context.createContext(req.name, Math.floor(1.61803398875*size), Math.floor(size), 0.5, 0);
    
    simulate.prepareSimulation(newSimulation,function(err)
        {
            if(err) { 
                res(err);
                return;
            }

            simulations.push(newSimulation);
            res(null,simulations);
        });
};

exports.deleteSimulation = function(req,res) {
    for(var i = simulations.length-1; i >= 0; --i) {
        var item = simulations[i];

        if(item.name == req) {
            simulations.splice(i, 1);
        }
    }
    res(null,simulations);
};
exports.clearSimulations = function(res) {
    simulations= new Array();
    res(null,simulations);
};
exports.getSimulations = function(res) {
    res(null,simulations);
};

function getSimulation (req,res)
{
    for(var s = 0 ; s < simulations.length;s++)
    {
        //console.log(simulations[s].name + " equals " + req + "?");
        if(simulations[s].name == req)
        {
            res(null, simulations[s]);
            return;
        }
    }
    res("Cannot find simulation named " + req.name + ".");
}

exports.getSimulationPackage = function(req,res) {

    // console.log("Get simulation package");
    // console.log(req);

    getSimulation(req,function(err,simulation) {
        
        if(err) { 
            res(err);
            return;
        }
        res(null, {
            name:simulation.name,
            columns:simulation.columns,
            rows:simulation.rows
        });
          
    });
};

exports.renderSimulation=function(req,res)
{
    // console.log("Render simulation");
    // console.log(req.name);
    
    getSimulation(req.name,function(err,simulation) {
        
        if(err) {
            res(err);
            return;
        }
        renderer.render(
            {
                ctx: simulation,
                mode: req.mode
            },
            function(err,colors)
            {
                if(err) {
                    res(err);
                    return;
                }

                res(null,colors);
            }
        );
    });
    
        
};

exports.queueSimulationRequest = function(request,res) {
    if(request.name && request.years)
    {
        if(request.years >= 1 && request.years <= 100 )
        {
            //  Do we have that simulation?
            for(var i = 0 ; i < simulations.length; i++) {
                if(request.name == simulations[i].name) 
                {
                    requests.push(request);
                    res(null,requests);
                    return;
                }
            }

            res("We do not have a simulation called " + 
                request.name + ".", requests);
        }
        else
        {
            res(request.name + " cannot be simulated for " + request.years + ". Year values must be between 1 and 100 inclusive.", requests);
        }
    }
    else 
    {
        res("Bad or missing request data.",requests);
    }
};

exports.deleteSimulationRequestsForWorld = function(request,res) {
    
    for(var i = requests.length-1; i >= 0; --i) {
        var item = requests[i];
        console.log(item);
        console.log(request);

        if(item.name == request.name) {
            requests.splice(i, 1);
        }
    }
    res(null,requests);
};

exports.getSimulationRequests = function(res) {
    res(null,requests);
};

exports.clearSimulationRequests = function(res) {
    requests = new Array();
    res(null,requests);
};
exports.processSimulationRequests = function(res)
{
    for(var r = 0 ; r < requests.length; r++) 
    {
        for(var s = 0 ; s < simulations.length ; s++)
        {
            if(requests[r].name == simulations[s].name) 
            {
                //  Actually simulate this


                //console.log("" + simulations[s].year+"+"+requests[r].years);
                simulations[s].year += requests[r].years;
            }
        }
    }
    requests = new Array();
    res(null,
        {
            requests:requests,
            simulations:simulations
        });
};


